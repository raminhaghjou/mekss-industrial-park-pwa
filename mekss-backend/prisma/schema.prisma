generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// enums
enum Role {
  SUPER_ADMIN
  PARK_MANAGER
  FACTORY_MANAGER
  SECURITY_GUARD
  GUEST
  EMPLOYEE
}

enum RequestType {
  MISSION
  TRANSFER
  DAILY_LEAVE
  HOURLY_LEAVE
  LOAN
  SETTLEMENT
  CONSTRUCTION_PERMIT
  FINAL_INSPECTION
  APPOINTMENT
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
}

enum GatePassStatus {
  PENDING
  APPROVED
  REJECTED
}

// main tables
model User {
  id                String   @id @default(cuid())
  phone             String   @unique
  username          String   @unique
  password          String   // hashed
  name              String
  nationalId        String?  // کد ملی
  role              Role
  isApproved        Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // relations
  factories         Factory[]
  gatePasses        GatePass[] @relation("createdBy")
  gatePassesApproved GatePass[] @relation("approvedBy")
  invoices          Invoice[]
  messagesSent      Message[] @relation("sender")
  messagesReceived  Message[] @relation("receiver")
  requestsCreated   Request[] @relation("creator")
  requestsApproved  Request[] @relation("approver")
  securityShifts    SecurityGuard[]
  announcements     Announcement[]
  advertisements    Advertisement[]
}

model Factory {
  id                String   @id @default(cuid())
  name              String
  licenseNumber     String   // شناسه واحد صنعتی
  nationalId        String   // شناسه ملی شرکت
  activityType      String
  address           String
  location          Json?    // {lat: number, lng: number}
  phone1            String
  phone2            String?
  fax               String?
  email             String?
  socialMedia       Json?    // {instagram, telegram}
  
  // relations
  managerId         String
  manager           User     @relation(fields: [managerId], references: [id])
  parkId            String
  park              IndustrialPark @relation(fields: [parkId], references: [id])
  gatePasses        GatePass[]
  invoices          Invoice[]
  requests          Request[]
}

model IndustrialPark {
  id                String   @id @default(cuid())
  name              String
  province          String
  city              String
  address           String
  guardPhone        String   // شماره نگهبانی
  logo              String?  // MinIO URL
  
  // relations
  factories         Factory[]
  announcements     Announcement[]
  securityGuards    SecurityGuard[]
}

model GatePass {
  id                String   @id @default(cuid())
  cargoType         String
  driverName        String
  driverNationalId  String
  vehicleType       String
  licensePlate      String   // پلاک خودرو
  exitDate          DateTime
  status            GatePassStatus @default(PENDING)
  
  // relations
  factoryId         String
  factory           Factory  @relation(fields: [factoryId], references: [id])
  createdById       String
  createdBy         User     @relation("createdBy", fields: [createdById], references: [id])
  approvedById      String?
  approvedBy        User?    @relation("approvedBy", fields: [approvedById], references: [id])
  approvedAt        DateTime?
  
  @@index([factoryId, createdAt])
}

model Invoice {
  id                String   @id @default(cuid())
  amount            Decimal  @db.Decimal(15, 2)
  description       String
  issueDate         DateTime @default(now())
  status            InvoiceStatus @default(PENDING)
  paymentDate       DateTime?
  
  // relations
  factoryId         String
  factory           Factory  @relation(fields: [factoryId], references: [id])
  createdById       String
  createdBy         User     @relation(fields: [createdById], references: [id])
  
  @@index([factoryId, status])
}

model Message {
  id                String   @id @default(cuid())
  subject           String
  body              String   @db.Text
  isRead            Boolean  @default(false)
  createdAt         DateTime @default(now())
  
  // relations
  senderId          String
  sender            User     @relation("sender", fields: [senderId], references: [id])
  receiverId        String
  receiver          User     @relation("receiver", fields: [receiverId], references: [id])
  
  @@index([receiverId, isRead])
}

model Request {
  id                String   @id @default(cuid())
  type              RequestType
  data              Json     // flexible form data
  status            String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt         DateTime @default(now())
  approvedAt        DateTime?
  
  // relations
  creatorId         String
  creator           User     @relation("creator", fields: [creatorId], references: [id])
  approverId        String?
  approver          User?    @relation("approver", fields: [approverId], references: [id])
  factoryId         String
  factory           Factory  @relation(fields: [factoryId], references: [id])
}

model Announcement {
  id                String   @id @default(cuid())
  title             String
  content           String   @db.Text
  isGlobal          Boolean  @default(false) // true = for all parks
  createdAt         DateTime @default(now())
  
  // relations
  parkId            String?
  park              IndustrialPark? @relation(fields: [parkId], references: [id])
  createdById       String
  createdBy         User     @relation(fields: [createdById], references: [id])
}

model Advertisement {
  id                String   @id @default(cuid())
  title             String
  category          String   // فروش ملک، استخدام، ماشین‌آلات
  province          String
  city              String
  content           String   @db.Text
  contactInfo       Json
  images            String[] // MinIO URLs
  isApproved        Boolean  @default(false)
  createdAt         DateTime @default(now())
  
  // relations
  createdById       String
  createdBy         User     @relation(fields: [createdById], references: [id])
}

model SecurityGuard {
  id                String   @id @default(cuid())
  shiftStart        DateTime
  shiftEnd          DateTime
  
  // relations
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  parkId            String
  park              IndustrialPark @relation(fields: [parkId], references: [id])
}
